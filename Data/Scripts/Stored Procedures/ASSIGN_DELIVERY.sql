--Procedimiento almacenado que se encarga de la asignacion de pedidos a repartidores.
--Toma como entrada el id del pedido, provincia, canton y distrito del comercio afiliado y busca posibles repartidores
--utilizando los parametros de la localizacion.

CREATE OR REPLACE PROCEDURE ASSIGN_DELIVERY(
	ID_PEDIDO_SP INT,
	PROVINCIA_SP VARCHAR(50),
	CANTON_SP VARCHAR(50),
	DISTRITO_SP VARCHAR(50))
language plpgsql
as $$
declare REPARTIDOR_SP VARCHAR(50);
begin
-- stored procedure body

INSERT INTO ORDERED_DM
SELECT USUARIO_REPART,PROVINCIA,CANTON,DISTRITO FROM REPARTIDOR
WHERE DISPONIBLE = TRUE
AND
(REPARTIDOR.PROVINCIA = PROVINCIA_SP AND REPARTIDOR.CANTON = CANTON_SP AND REPARTIDOR.DISTRITO = DISTRITO_SP);


IF (SELECT TRUE FROM ORDERED_DM LIMIT 1) THEN
	SELECT USUARIO_REPART FROM ORDERED_DM LIMIT 1 INTO REPARTIDOR_SP;
	UPDATE REPARTIDOR SET DISPONIBLE = FALSE
	WHERE REPARTIDOR.USUARIO_REPART = REPARTIDOR_SP;
	UPDATE PEDIDO SET 
	USUARIO_REPART = REPARTIDOR_SP,
	ID_ESTADO = 2
	WHERE PEDIDO.ID_PEDIDO = ID_PEDIDO_SP;
	
ELSE
	INSERT INTO ORDERED_DM
	SELECT USUARIO_REPART,PROVINCIA,CANTON,DISTRITO FROM REPARTIDOR
	WHERE DISPONIBLE = TRUE
	AND
	(REPARTIDOR.PROVINCIA = PROVINCIA_SP AND REPARTIDOR.CANTON = CANTON_SP);
	
	IF (SELECT TRUE FROM ORDERED_DM LIMIT 1) THEN
		SELECT USUARIO_REPART FROM ORDERED_DM LIMIT 1 INTO REPARTIDOR_SP;
		UPDATE REPARTIDOR SET DISPONIBLE = FALSE
		WHERE REPARTIDOR.USUARIO_REPART = REPARTIDOR_SP;
		UPDATE PEDIDO SET 
		USUARIO_REPART = REPARTIDOR_SP,
		ID_ESTADO = 2
		WHERE PEDIDO.ID_PEDIDO = ID_PEDIDO_SP;
	ELSE
		INSERT INTO ORDERED_DM
		SELECT USUARIO_REPART,PROVINCIA,CANTON,DISTRITO FROM REPARTIDOR
		WHERE DISPONIBLE = TRUE
		AND
		REPARTIDOR.PROVINCIA = PROVINCIA_SP;
		
		IF (SELECT TRUE FROM ORDERED_DM LIMIT 1) THEN
			SELECT USUARIO_REPART FROM ORDERED_DM LIMIT 1 INTO REPARTIDOR_SP;
			UPDATE REPARTIDOR SET DISPONIBLE = FALSE
			WHERE REPARTIDOR.USUARIO_REPART = REPARTIDOR_SP;
			UPDATE PEDIDO SET 
			USUARIO_REPART = REPARTIDOR_SP,
			ID_ESTADO = 2
			WHERE PEDIDO.ID_PEDIDO = ID_PEDIDO_SP;
		ELSE
			SELECT USUARIO_REPART FROM REPARTIDOR INTO REPARTIDOR_SP
			WHERE DISPONIBLE = TRUE LIMIT 1;
			UPDATE REPARTIDOR SET DISPONIBLE = FALSE
			WHERE REPARTIDOR.USUARIO_REPART = REPARTIDOR_SP;
			UPDATE PEDIDO SET 
			USUARIO_REPART = REPARTIDOR_SP,
			ID_ESTADO = 2
			WHERE PEDIDO.ID_PEDIDO = ID_PEDIDO_SP;
		END IF;
	END IF;
END IF;

DELETE FROM ORDERED_DM;
end; $$